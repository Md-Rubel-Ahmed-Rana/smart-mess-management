#!/bin/sh
# Husky v10 compatible pre-push hook

# Exit immediately if any command fails
set -e

# === Optional: Fetch latest remote refs to avoid "unknown revision" errors ===
git fetch origin || true

# Replace 'main' with your default branch if different
DEFAULT_BRANCH="main"

# Detect if frontend has any changes compared to remote main
CHANGED_FRONTEND=$(git diff --name-only origin/$DEFAULT_BRANCH HEAD | grep "^frontend/" || true)

if [ -n "$CHANGED_FRONTEND" ]; then
  echo "ğŸŸ¡ Frontend changes detected â€” running Next.js build..."

  cd frontend

  # Remove .next folder before installing/building
  if [ -d ".next" ]; then
    echo "=============================="
    echo "ğŸ§¹ Cleaning up previous Next.js build (.next folder)..."
    echo "=============================="
    rm -rf .next
    echo "âœ… .next folder removed successfully!"
  fi

  yarn install --silent
  yarn build || { echo "âŒ Frontend build failed"; exit 1; }

  echo "ğŸš€ Frontend build successful â€” pushing allowed!"
else
  echo "â„¹ï¸ No frontend changes â€” skipping Next.js build."
fi
